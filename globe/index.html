<head>
  <style>
    body {
      margin: 0;
    }
  </style>

  <script src="//unpkg.com/three"></script>

  <script src="//unpkg.com/globe.gl"></script>
  <!--<script src="../../dist/globe.gl.js"></script>-->
</head>

<body>
  <div id="globeViz"></div>

  <script>
    //issue: Need to find a way to avoid these global variables
    country_lats = [];
    country_longs = [];



    // Generate random data
    const N = 177;
    const gData = [...Array(N).keys()].map(() => ({
      lat: 0, //(Math.random() - 0.5) * 180,
      lng: 0, //(Math.random() - 0.5) * 360,
      alt: 0.1, //used to have up to .8 added
      width: 10,
      color: ['red', 'white', 'blue', 'green'][Math.round(Math.random() * 3)] 
    }));

    // Create globe
    const world = Globe({ animateIn: false }) //not sure what animateIn does because by pov setting below it animates
      (document.getElementById('globeViz'))
      // .globeImageUrl('//unpkg.com/three-globe/example/img/earth-dark.jpg')
      // .pointOfView({ altitude: 4 }, 5000)
      .showAtmosphere(false)
      .backgroundColor('#000000')
      .polygonCapColor(feat => 'rgba(0, 0, 0, 1)')
      .polygonStrokeColor(() => 'rgba(255, 255, 255, 1)')
      .polygonSideColor(() => 'rgba(0, 0, 0, 1)')
      .polygonLabel(({ properties: d }) => `
          <b>${d.ADMIN} (${d.ISO_A2})</b> <br />
          Population: <i>${Math.round(+d.POP_EST / 1e4) / 1e2}M</i>
        `)
      //scattering random squares on custom layer
      .customLayerData(gData)
      .customThreeObject(d => new THREE.Mesh(
        new THREE.PlaneGeometry(d.width, d.width),
        new THREE.MeshLambertMaterial({ color: d.color })
      ))
      .customThreeObjectUpdate((obj, d) => {
        Object.assign(obj.position, world.getCoords(d.lat, d.lng, d.alt));
        obj.lookAt(new THREE.Vector3(0, 0, 0));
        obj.material.side = THREE.DoubleSide;

      });

    // // Auto-rotate
    // world.controls().autoRotate = true;
    // world.controls().autoRotateSpeed = 1.8;

    //Loads JSON file of country data (?)
    fetch('./ne_110m_admin_0_countries.geojson').then(res => res.json()).then(countries => {
      //get center of bounding box per country
      //issue: there's probably a cleaner way to iterate here, not dry
      for (var i in countries.features) {
        country = countries.features[i];

        //issue: how to access this data after everything is loaded and move squares?
        avglat = (country.bbox[0] + country.bbox[2]) / 2;
        avglong = (country.bbox[1] + country.bbox[3]) / 2;
        country_lats.push(avglat);
        country_longs.push(avglong);
        // console.log(country.properties.ADMIN + ": " + avglat + ", " + avglong);

      }

      // Fills data for country labels
      world.polygonsData(countries.features.filter(d => d.properties.ISO_A2 !== 'AQ'));

      // //Moves country polygons outward
      // setTimeout(() => world
      //   .polygonsTransitionDuration(4000)
      //   .polygonAltitude(feat => Math.max(0.1, Math.sqrt(+feat.properties.POP_EST) * 7e-5))
      // , 3000);

      // //Animates scattered objects in custom layer
      // (function moveSpheres() {
      //   gData.forEach(d => d.lat += 0.2);
      //   world.customLayerData(world.customLayerData());
      //   requestAnimationFrame(moveSpheres);
      // })();

      // Moves squares to country bbox average
      // issue: shouldn't be called repeatedly
      // issue: shouldn't access globally stored values via index
      (function moveSpheres() {
        gData.forEach((d, i) => {
          d.lat = country_longs[i];
          d.lng = country_lats[i];
        });
        world.customLayerData(world.customLayerData());
        // requestAnimationFrame(moveSpheres);
      })();
    });
  </script>
</body>